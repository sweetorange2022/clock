<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>甜橙的时钟 & 倒计时</title>
<style>
/* 基础样式重置 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    position: relative;
}

/* 按钮样式 - 统一和谐配色 & 统一尺寸 */
.btn {
    position: fixed;
    padding: 12px 20px;
    background-color: #2c3e50; /* 深蓝灰色，更和谐 */
    color: #ecf0f1; /* 浅灰白色 */
    font-size: 16px;
    cursor: pointer;
    z-index: 9999;
    font-family: arial black, sans-serif;
    border-radius: 8px;
    border: none;
    transition: background-color 0.2s ease;
    right: 20px; /* 所有按钮统一右对齐 */
    width: 120px; /* 统一按钮宽度 */
    text-align: center; /* 文字居中 */
}

.btn:hover {
    background-color: #34495e; /* 悬停浅一点 */
}

.btn:active {
    background-color: #1a252f; /* 点击更深 */
}

/* 按钮位置调整 - 右侧垂直排列 */
#fullscreen-btn {
    top: 20px; /* 第一个按钮：顶部 */
}

#countdown-btn {
    top: 70px; /* 第二个按钮：全屏按钮下方（间距50px） */
}

#reset-countdown-btn {
    top: 120px; /* 第三个按钮：倒计时按钮下方 */
    display: none; /* 默认隐藏，倒计时界面显示 */
}

#back-btn {
    top: 70px; /* 和倒计时按钮同位置 */
    display: none;
}

/* 时间设置弹窗 - 优化样式 */
#modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #2c3e50;
    padding: 30px;
    border-radius: 10px;
    z-index: 10000;
    display: none;
    color: #ecf0f1;
    max-width: 350px;
    width: 90%;
}

/* 提示文字样式 */
.modal-tip {
    font-size: 14px;
    color: #f1c40f; /* 醒目黄色 */
    margin-bottom: 20px;
    line-height: 1.4;
    text-align: center;
}

/* 自定义下拉选择器容器 - 核心样式 */
.custom-select {
    position: relative;
    width: 80px;
    height: 44px; /* 和原select高度一致 */
    font-family: arial black, sans-serif;
}

/* 下拉触发按钮（替代原生select） */
.select-trigger {
    width: 100%;
    height: 100%;
    padding: 0 10px;
    background-color: #34495e;
    color: #ecf0f1;
    font-size: 18px;
    text-align: center; /* 文字绝对居中 */
    line-height: 44px;
    border-radius: 5px;
    border: 2px solid #34495e;
    cursor: pointer;
    transition: all 0.2s ease;
    /* 彻底隐藏原生滚轮相关样式 */
    overflow: hidden;
    white-space: nowrap;
}

.select-trigger:hover {
    background-color: #4a6580;
    border-color: #4a6580;
}

/* 下拉选项列表 */
.select-options {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 200px;
    background-color: #2c3e50;
    border-radius: 5px;
    margin-top: 5px;
    overflow-y: auto;
    display: none;
    z-index: 10001; /* 高于弹窗 */
    /* 美化滚动条（仅保留极细的样式，避免突兀） */
    scrollbar-width: thin;
    scrollbar-color: #4a6580 #2c3e50;
}

/* 自定义滚动条（Chrome/Safari） */
.select-options::-webkit-scrollbar {
    width: 4px; /* 极细滚动条，几乎不可见 */
}
.select-options::-webkit-scrollbar-track {
    background: #2c3e50;
}
.select-options::-webkit-scrollbar-thumb {
    background-color: #4a6580;
    border-radius: 2px;
}

/* 下拉选项 */
.select-options div {
    padding: 10px 0;
    text-align: center;
    color: #ecf0f1;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.select-options div:hover {
    background-color: #34495e;
}

/* 选择器容器间距微调 */
.time-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
    margin-bottom: 25px;
}

.time-selector span {
    font-size: 22px;
    font-weight: bold;
    color: #f1c40f;
}

#modal button {
    padding: 10px 20px;
    margin: 0 10px;
    font-size: 16px;
    border-radius: 5px;
    cursor: pointer;
    border: none;
    font-family: arial black, sans-serif;
    transition: background-color 0.2s ease;
    width: 100px; /* 弹窗按钮统一宽度 */
}

#confirm {
    background-color: #27ae60; /* 绿色确认 */
    color: white;
}

#confirm:hover {
    background-color: #2ecc71;
}

#cancel {
    background-color: #7f8c8d; /* 灰色取消 */
    color: white;
}

#cancel:hover {
    background-color: #95a5a6;
}

#overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 9999;
    display: none;
}

/* 时钟容器 */
#clock-wrap {
    width: 98%;
    margin: 0 auto;
    padding-top: 150px;
    text-align: center;
    color: #ecf0f1;
    font-family: arial black, sans-serif;
}

#line1 {
    font-size: 3vw;
    margin-bottom: 10px;
}

#line2 {
    font-size: 17vw;
    line-height: 1;
    margin-bottom: 15px;
}

#line3 {
    font-size: 10vw;
}

#clockcanvas {
    background-color: #000;
    margin: 0 auto;
}

/* 倒计时容器 - 动态字体大小优化 */
#countdown-wrap {
    width: 100%;
    height: 100%;
    margin: 0 auto;
    padding: 0 30px 0;
    text-align: center;
    color: #ecf0f1;
    font-family: arial black, sans-serif;
    display: none;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

#countdown-title {
    font-size: 4vw;
    margin-bottom: 20px;
    color: #ffffff; /* 纯白色标题 */
    white-space: nowrap; /* 确保一行显示 */
    width: 100%;
    text-align: center;
}

/* 基础字体大小 - 短内容正常显示 */
#countdown-show {
    font-size: 15vw; /* 正常内容的基础大小 */
    line-height: 1.2;
    margin-bottom: 0;
    white-space: nowrap; /* 强制一行显示 */
    width: 100%;
    text-align: center;
    overflow: visible;
    text-overflow: unset;
    letter-spacing: 0;
    transition: font-size 0.2s ease; /* 平滑过渡 */
}

/* 不同屏幕的基础字体适配 */
@media (max-width: 480px) {
    #countdown-show {
        font-size: 14vw; /* 手机小屏基础大小 */
    }
    #countdown-title {
        font-size: 4.5vw;
    }
}

@media (min-width: 1200px) {
    #countdown-show {
        font-size: 14vw; /* 大屏基础大小更大 */
    }
}

/* 隐藏原有的提示文本 */
#countdown-tip {
    display: none;
}
</style>
</head>
<body>
<!-- 功能按钮 - 右侧垂直排列（统一尺寸） -->
<button id="fullscreen-btn" class="btn">全屏显示</button>
<button id="countdown-btn" class="btn">倒计时</button>
<button id="reset-countdown-btn" class="btn">重新设置</button>
<button id="back-btn" class="btn">返回时钟</button>

<!-- 弹窗 - 增加提示文字 -->
<div id="overlay"></div>
<div id="modal">
    <div class="modal-tip">请设置倒计时终点时间<br/>（例如现在14点，可选14点以后的时间）</div>
    <div class="time-selector">
        <!-- 小时选择器：模拟下拉容器 -->
        <div class="custom-select">
            <div class="select-trigger" id="hour-trigger">00</div>
            <div class="select-options hour-options"></div>
            <!-- 保留原select，仅隐藏 -->
            <select id="hour-select" style="display: none;"></select>
        </div>
        <span>:</span>
        <!-- 分钟选择器：模拟下拉容器 -->
        <div class="custom-select">
            <div class="select-trigger" id="minute-trigger">00</div>
            <div class="select-options minute-options"></div>
            <!-- 保留原select，仅隐藏 -->
            <select id="minute-select" style="display: none;"></select>
        </div>
    </div>
    <div style="text-align: center;">
        <button id="confirm">确认</button>
        <button id="cancel">取消</button>
    </div>
</div>

<!-- 时钟区域 -->
<div id="clock-wrap">
    <div id="line1"></div>
    <div id="line2"></div>
    <div id="line3">
        <canvas id="clockcanvas" width="360" height="360"></canvas>
    </div>
</div>

<!-- 倒计时区域 - 简化显示 -->
<div id="countdown-wrap">
    <div id="countdown-title">距离目标时间还有</div>
    <div id="countdown-show">00 分 00 秒</div>
    <div id="countdown-tip">目标时间：--:--</div>
</div>

<!-- JS代码放在最后 -->
<script>
// ====================== 全局状态管理 ======================
// 保存倒计时状态，实现返回后恢复
var countdownState = {
    isSet: false,       // 是否已设置过倒计时
    targetTime: null,   // 目标时间
    timer: null,        // 倒计时定时器
    lastTextType: null  // 记录上一次的文本类型（用于避免重复调整字体）
};

// ====================== 基础工具函数 ======================
// 格式化时间（优化：不足10小时不补0，分钟/秒正常补0）
function fmt(num, type = 'normal') {
    // type: normal-正常补0（分/秒）, hour-小时专用（不足10不补0）
    if (type === 'hour') {
        return num.toString(); // 小时直接返回数字，不补0
    }
    return num < 10 ? '0' + num : num;
}

// 关闭弹窗
function closeModal() {
    document.getElementById('modal').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
}

/**
 * 获取文本类型（用于判断是否需要调整字体）
 * @param {string} text - 倒计时文本
 * @returns {string} 文本类型：short(仅分秒)、medium(个位数小时)、long(两位数小时)
 */
function getTextType(text) {
    const textLength = text.length;
    if (textLength <= 7) { // 仅分秒（如45分 10秒）
        return 'short';
    } else if (textLength <= 8) { // 个位数小时（如9时 05分 30秒）
        return 'medium';
    } else { // 两位数小时（如10时 05分 30秒）
        return 'long';
    }
}

/**
 * 动态调整倒计时字体大小（仅在文本类型变化时调整）
 * @param {string} text - 要显示的倒计时文本
 */
function adjustCountdownFontSize(text) {
    const showElement = document.getElementById('countdown-show');
    const screenWidth = window.innerWidth;
    const textType = getTextType(text);
    
    // 如果文本类型没有变化，不重复调整字体
    if (textType === countdownState.lastTextType) {
        return;
    }
    
    // 更新最后一次的文本类型
    countdownState.lastTextType = textType;
    
    // 先恢复基础字体大小（避免累积缩小）
    let baseFontSize;
    if (screenWidth <= 480) {
        baseFontSize = 13; // 从14改为13，同步CSS的小屏基础值
    } else if (screenWidth >= 1200) {
        baseFontSize = 17; // 从18改为17，同步CSS的大屏基础值
    } else {
        baseFontSize = 15; // 从16改为15，同步CSS的普通屏基础值
    }
    
    // 根据文本类型调整缩放比例
    let fontSizeScale = 1;
    switch(textType) {
        case 'medium': // 个位数小时
            fontSizeScale = screenWidth <= 480 ? 0.85 : 0.9;
            break;
        case 'long': // 两位数小时
            fontSizeScale = screenWidth <= 480 ? 0.7 : 0.8;
            break;
        case 'short': // 仅分秒，默认100%
        default:
            fontSizeScale = 1;
            break;
    }
    
    // 设置最终字体大小（使用vw单位，避免像素累积问题）
    const finalFontSize = baseFontSize * fontSizeScale;
    showElement.style.fontSize = finalFontSize + 'vw';
}

// ====================== 时钟功能 ======================
// 更新数字时钟
function updateDigitalClock() {
    var now = new Date();
    var year = now.getFullYear();
    var month = fmt(now.getMonth() + 1);
    var day = fmt(now.getDate());
    var hh = fmt(now.getHours());
    var mm = fmt(now.getMinutes());
    var ss = fmt(now.getSeconds());
    
    document.getElementById('line1').innerText = year + ' 年 ' + month + ' 月 ' + day + ' 日';
    document.getElementById('line2').innerText = hh + ':' + mm + ':' + ss;
}

// 绘制模拟时钟
function drawAnalogClock() {
    var canvas = document.getElementById('clockcanvas');
    var ctx = canvas.getContext('2d');
    var radius = canvas.height / 2;
    
    // 清除画布
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(radius, radius);
    radius = radius * 0.8;

    // 绘制表盘
    ctx.beginPath();
    ctx.arc(0, 0, radius, 0, 2 * Math.PI);
    ctx.fillStyle = 'white';
    ctx.fill();
    
    // 绘制刻度
    // 小时刻度
    for (var i = 0; i < 12; i++) {
        ctx.save();
        ctx.rotate(i * 30 * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(0, -radius);
        ctx.lineTo(0, -radius + 15);
        ctx.lineWidth = 5;
        ctx.strokeStyle = '#2c3e50';
        ctx.stroke();
        ctx.restore();
    }
    
    // 分钟刻度
    for (var i = 0; i < 60; i++) {
        ctx.save();
        ctx.rotate(i * 6 * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(0, -radius);
        ctx.lineTo(0, -radius + 8);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#2c3e50';
        ctx.stroke();
        ctx.restore();
    }
    
    // 绘制数字
    ctx.font = radius * 0.25 + 'px arial black';
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'center';
    for (var i = 1; i <= 12; i++) {
        var ang = i * 30 * Math.PI / 180;
        var x = Math.sin(ang) * radius * 0.8;
        var y = -Math.cos(ang) * radius * 0.8;
        ctx.fillText(i.toString(), x, y);
    }
    
    // 绘制指针
    var now = new Date();
    var h = now.getHours() % 12;
    var m = now.getMinutes();
    var s = now.getSeconds();
    
    // 时针
    ctx.save();
    var hAng = (h * 30 + m * 0.5) * Math.PI / 180;
    ctx.rotate(hAng);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, -radius * 0.5);
    ctx.lineWidth = 7;
    ctx.strokeStyle = '#2c3e50';
    ctx.lineCap = 'round';
    ctx.stroke();
    ctx.restore();
    
    // 分针
    ctx.save();
    var mAng = (m * 6 + s * 0.1) * Math.PI / 180;
    ctx.rotate(mAng);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, -radius * 0.8);
    ctx.lineWidth = 4;
    ctx.strokeStyle = '#2c3e50';
    ctx.lineCap = 'round';
    ctx.stroke();
    ctx.restore();
    
    // 秒针
    ctx.save();
    var sAng = s * 6 * Math.PI / 180;
    ctx.rotate(sAng);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(0, -radius * 0.9);
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#e74c3c';
    ctx.lineCap = 'round';
    ctx.stroke();
    ctx.restore();
    
    // 中心圆点
    ctx.beginPath();
    ctx.arc(0, 0, 8, 0, 2 * Math.PI);
    ctx.fillStyle = '#2c3e50';
    ctx.fill();
    
    ctx.restore();
}

// ====================== 全屏功能 ======================
function toggleFullscreen() {
    var doc = document.documentElement;
    if (!document.fullscreenElement) {
        doc.requestFullscreen ? doc.requestFullscreen() :
        doc.webkitRequestFullscreen ? doc.webkitRequestFullscreen() :
        doc.msRequestFullscreen && doc.msRequestFullscreen();
        document.getElementById('fullscreen-btn').innerText = '退出全屏';
    } else {
        document.exitFullscreen ? document.exitFullscreen() :
        document.webkitExitFullscreen ? document.webkitExitFullscreen() :
        document.msExitFullscreen && document.msExitFullscreen();
        document.getElementById('fullscreen-btn').innerText = '全屏显示';
    }
}

// ====================== 倒计时功能 - 支持重新设置 & 动态字体 ======================
// 初始化时间选择器（仅显示当天未到的时间）
function initTimeSelector() {
    var now = new Date();
    var currentHour = now.getHours();
    var currentMinute = now.getMinutes();
    
    var hourSelect = document.getElementById('hour-select');
    var minuteSelect = document.getElementById('minute-select');
    
    // 清空原有选项
    hourSelect.innerHTML = '';
    minuteSelect.innerHTML = '';
    
    // 填充小时选项（从当前小时开始到23点）
    for (var h = currentHour; h < 24; h++) {
        var option = document.createElement('option');
        option.value = h;
        option.text = fmt(h); // 选择器里正常显示补0的小时
        hourSelect.appendChild(option);
    }

    // --- 修复点1：设置小时默认选中第一项 ---
    if (hourSelect.options.length > 0) {
        hourSelect.selectedIndex = 0;
    }
    
    // 填充分钟选项（如果是当前小时，从下一分钟开始；否则从0开始）
    var startMinute = (hourSelect.value == currentHour) ? currentMinute + 1 : 0;
    for (var m = startMinute; m < 60; m++) {
        var option = document.createElement('option');
        option.value = m;
        option.text = fmt(m);
        minuteSelect.appendChild(option);
    }

    // --- 修复点2：设置分钟默认选中第一项 ---
    if (minuteSelect.options.length > 0) {
        minuteSelect.selectedIndex = 0;
    }
    
    // 监听小时变化，更新分钟选项
    hourSelect.onchange = function() {
        minuteSelect.innerHTML = '';
        var selectedHour = parseInt(this.value);
        var minStart = (selectedHour == currentHour) ? currentMinute + 1 : 0;
        
        for (var m = minStart; m < 60; m++) {
            var option = document.createElement('option');
            option.value = m;
            option.text = fmt(m);
            minuteSelect.appendChild(option);
        }
        
        // 设置新的分钟默认选中第一项
        if (minuteSelect.options.length > 0) {
            minuteSelect.selectedIndex = 0;
        }

        // 如果没有可选分钟，禁用确认按钮
        if (minuteSelect.options.length === 0) {
            document.getElementById('confirm').disabled = true;
            alert('当前时段已无可用时间，请选择其他小时！');
        } else {
            document.getElementById('confirm').disabled = false;
        }
    };
}

// 初始化自定义下拉选择器
function initCustomSelectors() {
    const hourSelect = document.getElementById('hour-select');
    const minuteSelect = document.getElementById('minute-select');
    const hourTrigger = document.getElementById('hour-trigger');
    const minuteTrigger = document.getElementById('minute-trigger');
    const hourOptions = document.querySelector('.hour-options');
    const minuteOptions = document.querySelector('.minute-options');

    // 同步原生select到自定义触发按钮
    function syncTrigger() {
        // 增加容错：如果值为空，默认显示00
        const hourVal = hourSelect.value !== null ? parseInt(hourSelect.value) : 0;
        const minVal = minuteSelect.value !== null ? parseInt(minuteSelect.value) : 0;
        
        hourTrigger.innerText = fmt(hourVal);
        minuteTrigger.innerText = fmt(minVal);
    }

    // 渲染自定义选项
    function renderOptions(select, optionsContainer) {
        optionsContainer.innerHTML = '';
        for (let i = 0; i < select.options.length; i++) {
            const option = document.createElement('div');
            option.innerText = select.options[i].text;
            option.dataset.value = select.options[i].value;
            option.onclick = function() {
                select.value = this.dataset.value;
                syncTrigger();
                optionsContainer.style.display = 'none';
            };
            optionsContainer.appendChild(option);
        }
    }

    // 绑定触发按钮点击事件
    hourTrigger.onclick = function(e) {
        e.stopPropagation();
        minuteOptions.style.display = 'none';
        hourOptions.style.display = hourOptions.style.display === 'block' ? 'none' : 'block';
        renderOptions(hourSelect, hourOptions);
    };

    minuteTrigger.onclick = function(e) {
        e.stopPropagation();
        hourOptions.style.display = 'none';
        minuteOptions.style.display = minuteOptions.style.display === 'block' ? 'none' : 'block';
        renderOptions(minuteSelect, minuteOptions);
    };

    // 点击页面其他区域关闭下拉
    document.addEventListener('click', function() {
        hourOptions.style.display = 'none';
        minuteOptions.style.display = 'none';
    });

    // 监听原生select变化，同步到自定义触发按钮
    hourSelect.onchange = function() {
        // 保留原有逻辑
        minuteSelect.innerHTML = '';
        var selectedHour = parseInt(this.value);
        var now = new Date();
        var currentHour = now.getHours();
        var currentMinute = now.getMinutes();
        var minStart = (selectedHour == currentHour) ? currentMinute + 1 : 0;
        
        for (var m = minStart; m < 60; m++) {
            var option = document.createElement('option');
            option.value = m;
            option.text = fmt(m);
            minuteSelect.appendChild(option);
        }

        // 设置新的分钟默认选中第一项
        if (minuteSelect.options.length > 0) {
            minuteSelect.selectedIndex = 0;
        }
        
        if (minuteSelect.options.length === 0) {
            document.getElementById('confirm').disabled = true;
            alert('当前时段已无可用时间，请选择其他小时！');
        } else {
            document.getElementById('confirm').disabled = false;
        }
        // 新增：同步自定义选择器
        syncTrigger();
        renderOptions(minuteSelect, minuteOptions);
    };

    // 初始化时同步
    syncTrigger();
}

// 打开倒计时设置弹窗（用于首次设置和重新设置）
function openCountdownModal() {
    // 停止当前倒计时（如果有）
    if (countdownState.timer) {
        clearInterval(countdownState.timer);
        countdownState.timer = null;
    }
    
    // 重置文本类型记录
    countdownState.lastTextType = null;
    
    // 初始化选择器并打开弹窗
    initTimeSelector();
    // 确保自定义选择器基于最新的原生select状态重新渲染
    initCustomSelectors();
    document.getElementById('modal').style.display = 'block';
    document.getElementById('overlay').style.display = 'block';
}

// 打开倒计时功能（支持恢复之前的设置）
function openCountdown() {
    // 重置文本类型记录
    countdownState.lastTextType = null;
    
    // 优化：先清除过期的状态
    if (countdownState.isSet && countdownState.targetTime) {
        var now = new Date();
        // 如果目标时间已过，直接重置状态，不再复用
        if (countdownState.targetTime <= now) {
            countdownState.isSet = false;
            countdownState.targetTime = null;
        }
    }
    
    // 如果已有有效设置，直接恢复；否则打开弹窗
    if (countdownState.isSet && countdownState.targetTime) {
        showCountdownPage();
        return;
    }
    
    // 无有效设置，打开设置弹窗
    openCountdownModal();
}

// 验证并设置倒计时（仅当天未到的时间）
function setCountdown() {
    var hour = parseInt(document.getElementById('hour-select').value);
    var minute = parseInt(document.getElementById('minute-select').value);
    
    // 创建目标时间（当天）
    var now = new Date();
    var targetTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);
    
    // 双重验证（防止异常）
    if (targetTime <= now) {
        alert('请选择今天还未到的时间！');
        initTimeSelector();
        initCustomSelectors(); // 重新同步
        return;
    }
    
    // 保存倒计时状态
    countdownState.isSet = true;
    countdownState.targetTime = targetTime;
    
    // 关闭弹窗，切换到倒计时页面
    closeModal();
    showCountdownPage();
}

// 显示倒计时页面（支持恢复状态）
function showCountdownPage() {
    // 停止之前的定时器（如果有）
    if (countdownState.timer) {
        clearInterval(countdownState.timer);
    }
    
    // 重置文本类型记录
    countdownState.lastTextType = null;
    
    // 切换显示状态
    document.getElementById('clock-wrap').style.display = 'none';
    document.getElementById('countdown-wrap').style.display = 'flex'; // 改为flex显示
    document.getElementById('countdown-btn').style.display = 'none';
    document.getElementById('reset-countdown-btn').style.display = 'block'; // 显示重新设置按钮
    document.getElementById('back-btn').style.display = 'block';
    
    // 格式化目标时间文本
    var targetHour = fmt(countdownState.targetTime.getHours());
    var targetMinute = fmt(countdownState.targetTime.getMinutes());
    var targetStr = targetHour + ':' + targetMinute;
    
    // 更新标题：距离10:00还有（纯白色）
    document.getElementById('countdown-title').innerText = '距离' + targetStr + '还有';
    
    // 启动倒计时
    startCountdown();
}

// 返回时钟页面（保留倒计时状态）
function backToClock() {
    // 暂停倒计时（保留定时器引用）
    if (countdownState.timer) {
        clearInterval(countdownState.timer);
    }
    
    // 切换显示状态
    document.getElementById('countdown-wrap').style.display = 'none';
    document.getElementById('clock-wrap').style.display = 'block';
    document.getElementById('back-btn').style.display = 'none';
    document.getElementById('reset-countdown-btn').style.display = 'none'; // 隐藏重新设置按钮
    document.getElementById('countdown-btn').style.display = 'block';
}

// 启动倒计时（支持状态恢复 + 修复字体持续缩小问题）
function startCountdown() {
    // 新增：先清除已有定时器，避免重复创建
    if (countdownState.timer) {
        clearInterval(countdownState.timer);
        countdownState.timer = null;
    }
    
    // 启动新的定时器并保存引用
    countdownState.timer = setInterval(function() {
        var now = new Date();
        var diff = countdownState.targetTime - now;
        
        if (diff <= 0) {
            // 倒计时结束，重置状态
            clearInterval(countdownState.timer);
            countdownState.isSet = false;
            countdownState.timer = null;
            countdownState.lastTextType = null;
            
            const endText = '00 分 00 秒';
            document.getElementById('countdown-show').innerText = endText;
            adjustCountdownFontSize(endText); // 调整结束文本的字体
            document.getElementById('countdown-title').innerText = '倒计时结束！';
            // 优化：不隐藏重新设置按钮
            document.getElementById('reset-countdown-btn').style.display = 'block'; 
            return;
        }
        
        // 计算时分秒
        var h = Math.floor(diff / 3600000);
        var m = Math.floor((diff % 3600000) / 60000);
        var s = Math.floor((diff % 60000) / 1000);
        
        // 最终显示逻辑：
        // 1. 不足1小时：只显示分秒（XX分 XX秒）
        // 2. 1-9小时：显示个位小时 + 分秒（9时 05分 30秒）
        // 3. 10小时及以上：显示完整小时 + 分秒（10时 05分 30秒）
        var displayText = '';
        if (h > 0) {
            // 小时使用专用格式化（不补0），分秒正常补0
            displayText = fmt(h, 'hour') + '时' + fmt(m) + '分' + fmt(s) + '秒';
        } else {
            displayText = fmt(m) + '分 ' + fmt(s) + '秒';
        }
        
        // 更新显示内容
        document.getElementById('countdown-show').innerText = displayText;
        // 动态调整字体大小（仅在文本类型变化时执行）
        adjustCountdownFontSize(displayText);
        
    }, 1000);
}

// 监听窗口大小变化，重新调整字体（重置文本类型确保重新计算）
window.addEventListener('resize', function() {
    const showElement = document.getElementById('countdown-show');
    const currentText = showElement.innerText;
    if (currentText && currentText !== '00 分 00 秒') {
        // 重置文本类型，强制重新计算
        countdownState.lastTextType = null;
        adjustCountdownFontSize(currentText);
    }
});

// ====================== 事件绑定 & 初始化 ======================
window.onload = function() {
    // 初始化时钟
    updateDigitalClock();
    drawAnalogClock();
    setInterval(updateDigitalClock, 1000);
    setInterval(drawAnalogClock, 1000);
    
    // 初始化倒计时默认字体
    adjustCountdownFontSize('00 分 00 秒');
    
    // 绑定按钮事件
    document.getElementById('fullscreen-btn').onclick = toggleFullscreen;
    document.getElementById('countdown-btn').onclick = openCountdown;
    document.getElementById('reset-countdown-btn').onclick = openCountdownModal; // 重新设置倒计时
    document.getElementById('back-btn').onclick = backToClock;
    document.getElementById('confirm').onclick = setCountdown;
    document.getElementById('cancel').onclick = closeModal;
    document.getElementById('overlay').onclick = closeModal;
};
</script>
</body>
</html>